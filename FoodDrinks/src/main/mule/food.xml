<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:validation="http://www.mulesoft.org/schema/mule/validation" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd">
	<sub-flow name="Food_categories" doc:id="2d13912b-40b9-417f-9eb5-21d7bf0420cb" >
		<set-variable value="#[message.attributes.queryParams.category]" doc:name="category" doc:id="27733f1c-301f-4399-964d-a5f4b4524f53" variableName="category" />
		<http:request method="GET" doc:name="GET/ mealCategory" doc:id="94fa30ac-f68f-4ee3-8036-8ee89bf0ff33" config-ref="HTTP_Request_food_configuration" path="/list.php">
			<http:headers><![CDATA[#[output application/java
---
{
	Authorization : "1"
}]]]></http:headers>
			<http:query-params><![CDATA[#[output application/java
---
{
	"c" : vars.category
}]]]></http:query-params>
		</http:request>
		<choice doc:name="Choice" doc:id="1a1a9354-53c4-4881-a35a-50f6876bbc80" >
			<when expression="#[(not isEmpty(vars.category))]" >
				<http:request method="GET" doc:name="GET/ mealCategory" doc:id="937942f2-13db-4b49-a13e-d13ab047c3e1" config-ref="HTTP_Request_food_configuration" path="/list.php" >
					<http:headers ><![CDATA[#[output application/java
---
{
	Authorization : "1"
}]]]></http:headers>
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.category
}]]]></http:query-params>
				</http:request>
				<ee:transform doc:name="payload" doc:id="2afa35e2-8059-466e-a7b3-9b613e5f9fbb">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="vars.category"><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
				<logger level="INFO" doc:name="Log at the end meal" doc:id="99f06108-a68e-4de7-90ab-f11a50bff2e0" message="Log at the end of request mealCategory" />
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Is empty category" doc:id="23041add-9918-4172-94c6-46bf9842141f" message="If Category is empty customer gets no response" />
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Logger finished" doc:id="4ba3468e-d438-481b-a032-f7494b5c25e9" message="Finished logging to the request by categories" />
	</sub-flow>
	<sub-flow name="Filter_food" doc:id="fe5216f8-627d-4d5e-83c3-d347a758725a" >
		<set-variable value="#[attributes.queryParams.foodType]" doc:name="foodType" doc:id="7b8def35-4853-4a71-9ddc-63e4fe665cf1" variableName="foodType" />
		<set-variable value="#[attributes.queryParams.ingredient]" doc:name="ingredient" doc:id="a29db092-d93a-459c-84b1-b6d0c086f8f1" variableName="ingredient" />
		<choice doc:name="Choice" doc:id="66c72beb-dcb0-4d00-8cc6-05a2841f5afc" >
			<when expression="#[(not isEmpty(vars.foodType))]" >
				<http:request method="GET" doc:name="GET/ foodType" doc:id="a558eccf-16fa-4635-8c79-ca0e4ed44789" config-ref="HTTP_Request_food_configuration" path="/filter.php" >
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.foodType
}]]]></http:query-params>
				</http:request>
				<logger level="INFO" doc:name="Log at the end foodType" doc:id="33fe4c5b-1ced-47df-a52e-bc3d08674bf3" message="Log at the end of foodType request" />
			</when>
			<when expression="#[(not isEmpty(vars.ingredient))]" >
				<http:request method="GET" doc:name="GET/ ingredient" doc:id="6d066f59-fea6-4b8d-a6dd-eeb8b7632f53" config-ref="HTTP_Request_food_configuration" path="/filter.php" >
					<http:query-params ><![CDATA[#[output application/java
---
{
	"i" : vars.ingredient
}]]]></http:query-params>
				</http:request>
				<logger level="INFO" doc:name="Log at the end ingredient" doc:id="c0c45208-7307-4678-a315-3d16371c646b" message="log at the end of ingredient request" />
			</when>
			<otherwise >
				<http:request method="GET" doc:name="GET/ Categories" doc:id="bafdded3-47c6-4247-b5c9-1a57be1627bd" config-ref="HTTP_Request_food_configuration" path="/categories.php" />
				<logger level="INFO" doc:name="Log category" doc:id="d83f9bcd-3e30-405c-97bb-780afc3ff2a2" message="if request has no query customer gets the list of  all categories" />
			</otherwise>
		</choice>
		<ee:transform doc:name="payload" doc:id="361ce7af-6df0-461e-915f-f7946a285569" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger finished" doc:id="357c6556-6d1e-45d4-8a8d-6a588b5896ad" message="Finished logging to the request by foodType" />
	</sub-flow>
	<sub-flow name="searchFoodByName" doc:id="b74923c7-d64c-4b44-800d-47b7a8a92cb0">
		<set-variable value="#[attributes.queryParams.foodByName]" doc:name="foodByName" doc:id="4e24dbb0-d1d5-4815-9985-bf51093ae6b5" variableName="cocktailByName" />
		<http:request method="GET" doc:name="GET /foodByName" doc:id="7defbf0c-5d37-409a-a6eb-c6709a43f372" config-ref="HTTP_Request_food_configuration" path="/search.php">
			<http:query-params><![CDATA[#[output application/java
---
{
	"s" : vars.cocktailByName
}]]]></http:query-params>
		</http:request>
		<ee:transform doc:name="data to JSON" doc:id="52fec31b-bef9-43ff-97b4-39d1fdc386b1">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
fun findKey(key)
= key match {
  case is String -> key
  else -> "null"
}
---
{
	meals: payload.meals map ( meal , indexOfMeal ) -> {
		"idMeal": meal.idMeal,
		"Meal": meal.strMeal,
		"Category" : meal.strCategory,		
		"Tags": meal.strTags,
		"Video": meal.strYoutube,	
		"ImageSource": meal.strMealThumb,
		"Instructions": meal.strInstructions,
		"Ingredients": {
			(findKey(meal.strIngredient1)): meal.strMeasure1,
			(findKey(meal.strIngredient2)): meal.strMeasure2,
			(findKey(meal.strIngredient3)): meal.strMeasure3,	
			(findKey(meal.strIngredient4)): meal.strMeasure4,
			(findKey(meal.strIngredient5)): meal.strMeasure5,
			(findKey(meal.strIngredient6)): meal.strMeasure6,	
			(findKey(meal.strIngredient7)): meal.strMeasure7,
			(findKey(meal.strIngredient8)): meal.strMeasure8
		},	
	}
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="e6656fcf-2d47-4921-8004-00d8474d9519" />
	</sub-flow>
	<sub-flow name="CategoryList" doc:id="9dcf589b-e45e-4738-869d-6e5a7ebc9135" >
		<logger level="INFO" doc:name="Starting to log the list of categories" doc:id="18f8dc5e-0db0-493c-a63f-32b6c02fef66" message="Logger started at the flow list of categories"/>
		<set-variable value='#[["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"]]' doc:name="alphabet" doc:id="888e9cb9-2976-432c-a537-9235e957ac0f" variableName="alphabet"/>
		<set-variable value="#[[]]" doc:name="varsLetter" doc:id="2a20827a-a489-40d8-8292-76206df278e1" variableName="varsLetter"/>
		<foreach doc:name="For Each by Alphabet" doc:id="4b817eb6-10c5-452f-a285-4db9ead8c41d" collection="#[vars.alphabet]">
			<logger level="INFO" doc:name="Logging is started" doc:id="ed2115b8-fdfb-4174-a182-f5f1de340893" message="Started to log the request"/>
			<http:request method="GET" doc:name="GET /FoodList" doc:id="0cc6acdb-5b5a-4fe3-b6c4-b7993f80a6aa" config-ref="HTTP_Request_food_configuration" path="/search.php">
				<http:query-params ><![CDATA[#[output application/java
---
{
	"s" : payload
}]]]></http:query-params>
			</http:request>
			<ee:transform doc:name="Transform to payload" doc:id="b96b6bb0-9d74-4105-8796-ff43f32384cb" >
				<ee:message >
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="varsLetter" ><![CDATA[%dw 2.0
output application/json
---
vars.varsLetter + payload]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</foreach>
		<ee:transform doc:name="varsletter" doc:id="438c5791-f512-4885-8805-11d0c9a4f81f" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars.varsLetter]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="ListofCollection" doc:id="48d14092-4bf7-4123-8d2e-84a9445f01a8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
flatten(payload.meals)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Log at the end" doc:id="d520edcc-f0a5-45b3-b13c-78b293665b0e" message="Logging is finished"/>
	</sub-flow>
	<sub-flow name="MenuByCategories" doc:id="78bee59e-21b9-45b0-ba78-d805dd0bfbaf" >
		<set-variable value="#[message.attributes.queryParams.category]" doc:name="category" doc:id="c3e171d8-4ef2-4c74-a45f-240d4aa743a7" variableName="category" />
		<validation:is-not-null doc:name="Is not null vars category" doc:id="8ef50967-cc38-4ddc-9a5b-bfa6bf086dec" value="#[vars.category]" message='#["Add the category of any meal types"]' >
			<error-mapping sourceType="VALIDATION:NULL" targetType="APP:CATEGORYNULL" />
		</validation:is-not-null>
		<http:request method="GET" doc:name="GET/ mealCategory" doc:id="b2b5f2b4-f955-4ab1-a8ad-ca0b2517222c" config-ref="HTTP_Request_food_configuration" path="/list.php" >
			<http:headers ><![CDATA[#[output application/java
---
{
	Authorization : "1"
}]]]></http:headers>
			<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.category
}]]]></http:query-params>
		</http:request>
		<choice doc:name="Choice" doc:id="e26f02aa-547a-4955-a771-86392bd3913f" >
			<when expression='#[vars.category == "Chicken"]'>
				<logger level="INFO" doc:name="Logger started at category Chicken" doc:id="7ae9654c-d5ca-4040-883c-e7d153f1ede3" message="Started to log the category Chicken for the meal types"/>
				<set-variable value='#["Shake"]' doc:name="Shake" doc:id="a0a81b9f-c369-4050-985e-d11c04f58548" variableName="Shake"/>
				<set-payload value="#[vars.shake]" doc:name="varsShake" doc:id="f2c4ea76-c64d-4823-afd7-3e9eb591ef26" />
				<http:request method="GET" doc:name="GEt /Shake" doc:id="7e540fdd-6be4-4dd7-9f36-348a719f36d2" config-ref="HTTP_Request_drinks_configuration" path="/filter.php">
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.shake
}]]]></http:query-params>
				</http:request>
				<ee:transform doc:name="payload" doc:id="b081e502-103b-4cd5-b596-07348ed29129" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<when expression='#[vars.category == "Pasta"]'>
				<logger level="INFO" doc:name="Logger started at category Pasta" doc:id="cc33574e-6941-47bc-8928-b839cf69bf9d" message="Started to log the category Pasta for the meal types"/>
				<set-variable value='#["Soft Drink"]' doc:name="soft Drink" doc:id="163ccf63-af0f-471f-8f4f-d920bf484c5d" variableName="softDrink" />
				<set-payload value="#[vars.softDrink]" doc:name="varsSoftDrink" doc:id="c90b4c58-300d-4491-9683-5042d6c2447b" />
				<http:request method="GET" doc:name="Get /SoftDrink" doc:id="a9f8e529-28be-4a2d-9ae4-9ed80c842f45" config-ref="HTTP_Request_drinks_configuration" path="/filter.php">
					<http:query-params><![CDATA[#[output application/java
---
{
	"c" : vars.softDrink
}]]]></http:query-params>
				</http:request>
				<ee:transform doc:name="payload" doc:id="5eedf87e-33d7-4622-9409-cd14aac5e4b0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<when expression='#[vars.category == "Breakfast"]'>
				<logger level="INFO" doc:name="Logger started at category Breakfast" doc:id="57042379-77b6-49e4-adc2-2894f407e31c" message="Started to log the category Breakfast for the meal types"/>
				<set-variable value='#["Cocoa"]' doc:name="Cocoa" doc:id="fb08757d-ae34-4234-b2e9-aaaf6c75186b" variableName="cocoa" />
				<set-payload value="#[vars.cocoa]" doc:name="varsCocoa" doc:id="d9c81fb4-6d86-49c3-8410-4b7404cba7df" />
				<http:request method="GET" doc:name="GEt /Cocoa" doc:id="998c04ab-5510-4851-a112-796fad85e0cc" config-ref="HTTP_Request_drinks_configuration" path="/filter.php">
					<http:query-params><![CDATA[#[output application/java
---
{
	"c" : vars.cocoa
}]]]></http:query-params>
				</http:request>
				<ee:transform doc:name="payload" doc:id="64e42714-57f9-4811-abfb-5975c291ba9b" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<when expression='#[vars.category == "Pork"]'>
				<logger level="INFO" doc:name="Logger started at category Pork" doc:id="cdabe04d-4c55-4f30-a86c-3d46513ec753" message="Started to log the category Pork for the meal types"/>
				<set-variable value='#["Homemade Liqueur"]' doc:name="homemadeLiqueur" doc:id="5ea48e92-1457-4a80-8266-4e0f40b4846e" variableName="homemadeLiqueur" />
				<set-payload value="#[vars.homemadeLiqueur]" doc:name="varsHomemadeLiqueur" doc:id="3db56565-cc49-40f6-ab6d-54081b143df7" />
				<http:request method="GET" doc:name="Get /HomemadeLiqueur" doc:id="971e3b30-9905-47ce-8217-9bb3230cf888" config-ref="HTTP_Request_drinks_configuration" path="/filter.php" >
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.homemadeLiqueur
}]]]></http:query-params>
				</http:request>
				<ee:transform doc:name="payload" doc:id="c77fb152-7eae-4bb4-8157-a9954aebddb8" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<when expression='#[vars.category == "Miscellaneous"]'>
				<logger level="INFO" doc:name="Logger" doc:id="6c010001-ded6-47bf-8ee1-db5fa0718ef0" />
				<set-variable value='#["Punch / Party Drink"]' doc:name="punch/PartyDrink" doc:id="f6191a6c-9869-4066-9832-4bd6be318373" variableName="punchPartyDrink" />
				<set-payload value="#[vars.punchPartyDrink]" doc:name="varsPunchPartyDrink" doc:id="2681c021-32e5-4e21-ae05-109ba28b9bef" />
				<http:request method="GET" doc:name="Get /punchPartyDrink" doc:id="f956bfca-ceea-4b4c-adec-a0d8d29486e3" config-ref="HTTP_Request_drinks_configuration" path="/filter.php">
					<http:query-params><![CDATA[#[output application/java
---
{
	"c" : vars.punchPartyDrink
}]]]></http:query-params>
				</http:request>
				<ee:transform doc:name="payload" doc:id="2310e649-48d9-431e-af87-9af6fe7c0a4a" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Log other meal categories" doc:id="b5bd758a-7af9-40ec-86d3-67a12d7a594b" message="Started to log other meal categories"/>
				<validation:is-true doc:name="Is true" doc:id="c54abcea-c896-424c-b9be-b88b3d704ca6" expression='#[["Beef", "Chicken", "Dessert", "Lamb", "Miscellaneous", "Pasta","Pork","Seafood","Side","Starter","Vegan","Vegetarian","Breakfast","Goat"]contains vars.category]' message='#["Thank you for your order! Enjoy your meal!"]' />
				<http:request method="GET" doc:name="GET /meal_categories" doc:id="99238ea2-3b06-4df9-9c48-41c1897df313" config-ref="HTTP_Request_food_configuration" path="/filter.php" >
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.category
}]]]></http:query-params>
				</http:request>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Logging is finished for the request" doc:id="43bab35e-6062-4995-8056-d6df00d07816" message="Finished logging to the meal categories"/>
	</sub-flow>
</mule>
