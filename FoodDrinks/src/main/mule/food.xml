<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="Food_categories" doc:id="2d13912b-40b9-417f-9eb5-21d7bf0420cb" >
		<set-variable value="#[attributes.queryParams.category]" doc:name="category" doc:id="27733f1c-301f-4399-964d-a5f4b4524f53" variableName="category" />
		<choice doc:name="Choice" doc:id="1a1a9354-53c4-4881-a35a-50f6876bbc80" >
			<when expression="#[(not isEmpty(vars.category))]" >
				<http:request method="GET" doc:name="GET/ mealCategory" doc:id="937942f2-13db-4b49-a13e-d13ab047c3e1" config-ref="HTTP_Request_food_configuration" path="/list.php" >
					<http:headers ><![CDATA[#[output application/java
---
{
	Authorization : "1"
}]]]></http:headers>
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.category
}]]]></http:query-params>
				</http:request>
				<logger level="INFO" doc:name="Log at the end meal" doc:id="99f06108-a68e-4de7-90ab-f11a50bff2e0" message="Log at the end of request mealCategory" />
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Is empty category" doc:id="23041add-9918-4172-94c6-46bf9842141f" message="If Category is empty customer gets no response" />
			</otherwise>
		</choice>
		<ee:transform doc:name="payload" doc:id="2afa35e2-8059-466e-a7b3-9b613e5f9fbb" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger finished" doc:id="09e741e5-5f33-4cde-9cc1-a546e208c378" message="Finished logging to the request by categories" />
	</sub-flow>
	<sub-flow name="Filter_food" doc:id="fe5216f8-627d-4d5e-83c3-d347a758725a" >
		<set-variable value="#[attributes.queryParams.foodType]" doc:name="foodType" doc:id="7b8def35-4853-4a71-9ddc-63e4fe665cf1" variableName="foodType" />
		<set-variable value="#[attributes.queryParams.ingredient]" doc:name="ingredient" doc:id="a29db092-d93a-459c-84b1-b6d0c086f8f1" variableName="ingredient" />
		<choice doc:name="Choice" doc:id="66c72beb-dcb0-4d00-8cc6-05a2841f5afc" >
			<when expression="#[(not isEmpty(vars.foodType))]" >
				<http:request method="GET" doc:name="GET/ foodType" doc:id="a558eccf-16fa-4635-8c79-ca0e4ed44789" config-ref="HTTP_Request_food_configuration" path="/filter.php" >
					<http:query-params ><![CDATA[#[output application/java
---
{
	"c" : vars.foodType
}]]]></http:query-params>
				</http:request>
				<logger level="INFO" doc:name="Log at the end foodType" doc:id="33fe4c5b-1ced-47df-a52e-bc3d08674bf3" message="Log at the end of foodType request" />
			</when>
			<when expression="#[(not isEmpty(vars.ingredient))]" >
				<http:request method="GET" doc:name="GET/ ingredient" doc:id="6d066f59-fea6-4b8d-a6dd-eeb8b7632f53" config-ref="HTTP_Request_food_configuration" path="/filter.php" >
					<http:query-params ><![CDATA[#[output application/java
---
{
	"i" : vars.ingredient
}]]]></http:query-params>
				</http:request>
				<logger level="INFO" doc:name="Log at the end ingredient" doc:id="c0c45208-7307-4678-a315-3d16371c646b" message="log at the end of ingredient request" />
			</when>
			<otherwise >
				<http:request method="GET" doc:name="GET/ Categories" doc:id="bafdded3-47c6-4247-b5c9-1a57be1627bd" config-ref="HTTP_Request_food_configuration" path="/categories.php" />
				<logger level="INFO" doc:name="Log category" doc:id="d83f9bcd-3e30-405c-97bb-780afc3ff2a2" message="if request has no query customer gets the list of  all categories" />
			</otherwise>
		</choice>
		<ee:transform doc:name="payload" doc:id="361ce7af-6df0-461e-915f-f7946a285569" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger finished" doc:id="04bf7b17-63ee-4c4f-95b3-c8df67c550fd" message="Finished logging to the request by foodType" />
	</sub-flow>
	<sub-flow name="searchFoodByName" doc:id="b74923c7-d64c-4b44-800d-47b7a8a92cb0">
		<set-variable value="#[attributes.queryParams.foodByName]" doc:name="foodByName" doc:id="4e24dbb0-d1d5-4815-9985-bf51093ae6b5" variableName="cocktailByName" />
		<http:request method="GET" doc:name="GET /foodByName" doc:id="7defbf0c-5d37-409a-a6eb-c6709a43f372" config-ref="HTTP_Request_food_configuration" path="/search.php">
			<http:query-params><![CDATA[#[output application/java
---
{
	"s" : vars.cocktailByName
}]]]></http:query-params>
		</http:request>
		<ee:transform doc:name="data to JSON" doc:id="52fec31b-bef9-43ff-97b4-39d1fdc386b1">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
fun findKey(key)
= key match {
  case is String -> key
  else -> "null"
}
---
{
	meals: payload.meals map ( meal , indexOfMeal ) -> {
		"idMeal": meal.idMeal,
		"Meal": meal.strMeal,
		"Category" : meal.strCategory,		
		"Tags": meal.strTags,
		"Video": meal.strYoutube,	
		"ImageSource": meal.strMealThumb,
		"Instructions": meal.strInstructions,
		"Ingredients": {
			(findKey(meal.strIngredient1)): meal.strMeasure1,
			(findKey(meal.strIngredient2)): meal.strMeasure2,
			(findKey(meal.strIngredient3)): meal.strMeasure3,	
			(findKey(meal.strIngredient4)): meal.strMeasure4,
			(findKey(meal.strIngredient5)): meal.strMeasure5,
			(findKey(meal.strIngredient6)): meal.strMeasure6,	
			(findKey(meal.strIngredient7)): meal.strMeasure7,
			(findKey(meal.strIngredient8)): meal.strMeasure8
		},	
	}
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="e6656fcf-2d47-4921-8004-00d8474d9519" />
	</sub-flow>
	<sub-flow name="CategoryList" doc:id="9dcf589b-e45e-4738-869d-6e5a7ebc9135" >
		<logger level="INFO" doc:name="Starting to log the list of categories" doc:id="18f8dc5e-0db0-493c-a63f-32b6c02fef66" message="Logger started at the flow list of categories"/>
		<set-variable value='#[["a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z"]]' doc:name="alphabet" doc:id="888e9cb9-2976-432c-a537-9235e957ac0f" variableName="alphabet"/>
		<set-variable value="#[[]]" doc:name="varsLetter" doc:id="2a20827a-a489-40d8-8292-76206df278e1" variableName="varsLetter"/>
		<foreach doc:name="For Each by Alphabet" doc:id="4b817eb6-10c5-452f-a285-4db9ead8c41d" collection="#[vars.alphabet]">
			<logger level="INFO" doc:name="Logging is started" doc:id="ed2115b8-fdfb-4174-a182-f5f1de340893" message="Started to log the request"/>
			<http:request method="GET" doc:name="GET /FoodList" doc:id="0cc6acdb-5b5a-4fe3-b6c4-b7993f80a6aa" config-ref="HTTP_Request_food_configuration" path="/search.php">
				<http:query-params ><![CDATA[#[output application/java
---
{
	"s" : payload
}]]]></http:query-params>
			</http:request>
			<ee:transform doc:name="Transform to payload" doc:id="b96b6bb0-9d74-4105-8796-ff43f32384cb" >
				<ee:message >
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="varsLetter" ><![CDATA[%dw 2.0
output application/json
---
vars.varsLetter + payload]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</foreach>
		<ee:transform doc:name="varsletter" doc:id="438c5791-f512-4885-8805-11d0c9a4f81f" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars.varsLetter]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="ListofCollection" doc:id="48d14092-4bf7-4123-8d2e-84a9445f01a8" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
flatten(payload.meals)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Log at the end" doc:id="d520edcc-f0a5-45b3-b13c-78b293665b0e" message="Logging is finished"/>
	</sub-flow>
</mule>
