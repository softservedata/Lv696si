<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="allteams" doc:id="aaa1eaff-0b8e-4142-a92e-21cdd7f1394c" >
		<http:request method="GET" doc:name="GET /allteams" doc:id="91409d0f-05f7-4893-862d-17667d2dbed8" config-ref="HTTP_Request_configuration" path="/teams">
		</http:request>
		<ee:transform doc:name="Transform All Teams To Array" doc:id="bf632308-b098-474f-b588-e03003ae037b" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload.data]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Number of Teams" doc:id="7f18e868-e01f-4556-badc-5eb7a1ca5764" message='#["Number of Teams " ++ sizeOf(payload)]'/>
	</sub-flow>
	<sub-flow name="allgames" doc:id="1d2abf3c-16a2-41dd-947e-ae276a0a3ac6" >
		<set-variable value="#[message.attributes.queryParams.season]" doc:name="season" doc:id="43d0bad2-cd24-499a-a489-9dd93d8b7797" variableName="season"/>
		<flow-ref doc:name="validSeason" doc:id="e7d8f3c2-eaed-4057-bc1c-8fcb3217be24" name="validSeason"/>
		<set-variable value="#[[]]" doc:name="games" doc:id="c523a437-c73d-461e-9f3a-ec880e2f0065" variableName="games" />
		<set-variable value="#[0]" doc:name="counter" doc:id="0972c1b1-8472-42f0-9044-9b54cf31fbe2" variableName="counter"/>
		<logger level="INFO" doc:name="Logger Before All Pages" doc:id="531fc58c-1443-4cd6-a166-0202d01d9a0b" message='#["Variable season " ++ vars.season]' />
		<flow-ref doc:name="findForAllPages1" doc:id="4978c520-35bf-4bfa-9d02-856b67100fd9" name="findForAllPages1"/>
		<ee:transform doc:name="All games for season" doc:id="779d098d-2204-4d12-a484-9fde214b3f8d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars.games]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Size of allGames" doc:id="71269e45-43ae-431a-8076-0c86f8296077" message='#["Size of allGames " ++ sizeOf(vars.games)]' />
	</sub-flow>
	<sub-flow name="findForAllPages1" doc:id="e439caac-40ff-4b26-9af7-b112374b7afb">
		<http:request method="GET" doc:name="GET /allgames first page" doc:id="799a4a9d-0a38-4c7b-b0af-a12ae225205f" config-ref="HTTP_Request_configuration" path="/games">
			<http:query-params><![CDATA[#[output application/java
---
{
	"postseason" : false,
	"seasons[]" : vars.season,
	"page" : 1,
	"per_page" : 100
}]]]></http:query-params>
		</http:request>
		<set-variable value="#[message.payload.meta.total_pages]" doc:name="numberOfpages" doc:id="6714c9e3-f7ae-4b97-8ab8-153a669598b4" variableName="numberOfpages" />
		<ee:transform doc:name="save result" doc:id="310db87e-a868-40e9-9a1c-d129a2a28e3f">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0 
output application/json 
--- 
payload]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="games"><![CDATA[%dw 2.0
output application/java
---
vars.games ++ payload.data]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="2 to numberOfPages" doc:id="f9b4666c-9063-4fd7-8294-b05535b699c1">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
2 to vars.numberOfpages]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="e2dd1e29-d462-4f41-b13a-4e5db0862ac4">
			<http:request method="GET" doc:name="GET /allgames from one page" doc:id="b8c593c3-877a-4d23-bf8f-847201813837" config-ref="HTTP_Request_configuration" path="/games">
				<http:query-params><![CDATA[#[output application/java
---
{
	"postseason" : false,
	"seasons[]" : vars.season,
	"page" : payload,
	"per_page" : 100
}]]]></http:query-params>
			</http:request>
			<ee:transform doc:name="save result" doc:id="3e271721-7113-4398-9e51-15b5d9d37dbb">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0 
output application/json 
--- 
payload]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="games"><![CDATA[%dw 2.0
output application/java
---
vars.games ++ payload.data]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		</foreach>
		<logger level="INFO" doc:name="Log number of pages" doc:id="50f41128-4c24-457d-909a-ad809f99b614" message='#["Number of Pages " ++ vars.numberOfpages]' />
	</sub-flow>
	<sub-flow name="gamesbyteamabr" doc:id="494a3ad1-b21a-472f-8446-78e5a9581483">
		<flow-ref doc:name="allgames" doc:id="99d11d63-0125-4f23-8aa6-d02f99a1f06e" name="allgames" />
		<ee:transform doc:name="filter by Abbr" doc:id="90a8bd08-30b2-41c9-ab2a-3edd4a53d777">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.home_team.abbreviation == vars.teamAbr 
	or object.visitor_team.abbreviation == vars.teamAbr
) 
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="transform to normal view with winner" doc:id="6b01c829-1a6b-4684-b701-d89a187fc95a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Number of Games" doc:id="dee3c419-55f5-490e-a122-b9f045874085" message='#["Number of games " ++ sizeOf(payload)]' />
	</sub-flow>
	<sub-flow name="gamesbyname" doc:id="e4187975-397e-4eb6-a89c-500f4a885ae1" >
		<flow-ref doc:name="allgames" doc:id="99e2fd7a-c6ef-407a-a6bf-86b25032a62f" name="allgames" />
		<ee:transform doc:name="filter by Name" doc:id="2e294d4a-dcfc-47d6-a069-559fc1896ea1" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.home_team.name == vars.teamName 
	or  object.visitor_team.name == vars.teamName
) 
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="transform to normal view with winner" doc:id="8923ed8b-2985-4d86-aef9-820726ee7d2a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Number of Games" doc:id="aeeac539-69e8-4733-b533-03f81a794dbc" message='#["Number of games " ++ sizeOf(payload)]' />
	</sub-flow>
	<sub-flow name="getGames" doc:id="2a76bb87-a759-41d4-b170-5e4f435c11da" >
		<set-variable value="#[message.attributes.queryParams.abbreviation]" doc:name="teamAbr" doc:id="0800195a-c730-48bb-912e-5993b858dd9d" variableName="teamAbr" />
		<set-variable value="#[message.attributes.queryParams.teamname]" doc:name="teamName" doc:id="ee1c136b-83ed-4fe9-a520-b35efa79486a" variableName="teamName" />
		<flow-ref doc:name="validNameAbbr" doc:id="3940018e-4f8f-40ec-a3d2-2b47c9a915ca" name="validNameAbbr"/>
		<choice doc:name="Choice" doc:id="ba82c9c6-16cb-4c75-9a72-896ac8fc4a93" >
			<when expression="#[(not isEmpty(vars.teamName)) and isEmpty(vars.teamAbr)]">
				<flow-ref doc:name="gamesbyname" doc:id="897e7ff4-4c69-4649-8e5d-9739518b149f" name="gamesbyname"/>
			</when>
			<when expression="#[isEmpty(vars.teamName) and (not isEmpty(vars.teamAbr))]">
				<flow-ref doc:name="gamesbyteamabr" doc:id="e83ff8d2-7bff-4952-ba42-d448b9d61fae" name="gamesbyteamabr"/>
			</when>
			<otherwise >
				<flow-ref doc:name="allgames" doc:id="e0af97a3-a733-47b6-aa16-d97c9eceba53" name="allgames" />
				<ee:transform doc:name="transform to normal view with winner" doc:id="de8411e6-7fff-4c86-a738-04388c13bf11">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Number of games " doc:id="75f8cbea-3461-404b-95cd-f838ef11c570" message='#["Number of games " ++ sizeOf(payload)]'/>
	</sub-flow>
	<sub-flow name="findWinnersOfTheGame" doc:id="01a9fd52-9c8b-40ae-9b4f-ecfa27f9c877" >
		<flow-ref doc:name="allgames" doc:id="7fd08f48-fbbe-4c9c-bbff-6db282f5337c" name="allgames"/>
		<ee:transform doc:name="to normal view with winner and looser" doc:id="3649b27d-46f8-4227-874e-cd531c6173b0">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation),
	looser: if(payload01.home_team_score < payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation),
				
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="find Team Record and Full Standings" doc:id="4ed25f5d-fdeb-474c-a7f8-d292cc1ce026">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
import * from dw::core::Arrays

---
((payload map ( object , index ) -> {
	team_abbr : object.winner,
	wins: payload.*winner countBy($ == object.winner),
	losses : payload.*looser countBy($ == object.winner),	
}) distinctBy $.team_abbr) orderBy -$.wins]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Calculate Percentage and Sort" doc:id="a57efd1a-4186-4448-9723-d423703b1f98" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
(payload map ( object , index ) -> {
	team_abbr : object.team_abbr,
	wins: object.wins,
	losses : object.losses,
	percentage: (object.wins/(object.losses + object.wins))	
}) orderBy -$.percentage ]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Number of Teams" doc:id="6b4a129a-3d12-4821-a6f7-a5d345a892af" message='#["Number of Teams " ++ sizeOf(payload)]' />
	</sub-flow>
	<sub-flow name="addAdditionalInfo" doc:id="09e1db7b-5f5b-4352-8f7b-0aeb5f1cddf2" >
		<flow-ref doc:name="findWinnersOfTheGame" doc:id="3468603c-632e-452f-8197-b461a44d1d01" name="findWinnersOfTheGame"/>
		<set-variable value="#[null]" doc:name="Info" doc:id="8b641a11-42ba-4c94-9404-e9f598265490" variableName="Info"/>
		<set-variable value="#[[]]" doc:name="newPayload" doc:id="cb1d740b-0ef9-4b50-a2b0-4e7d483ddf36" variableName="newPayload"/>
		<foreach doc:name="For Each" doc:id="00bbc96d-2246-48a0-a9f0-01e02a557f90" collection="#[payload]">
			<set-variable value="#[payload.team_abbr]" doc:name="teamAbbr" doc:id="e725417e-6065-434b-aa7c-ba4261c57afb" variableName="teamAbbr"/>
			<set-variable value="#[payload]" doc:name="thisPayload" doc:id="191021d5-e71e-4085-af29-0633a194e02e" variableName="thisPayload"/>
			<flow-ref doc:name="findTeamByAbbr" doc:id="27f19481-d9e5-4d0b-9a14-906386e1335a" name="findTeamByAbbr" targetValue="#[vars.Info]"/>
			<ee:transform doc:name="return old payload" doc:id="026a3680-458e-4f2d-aaad-76f3a55f996c" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars.thisPayload]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<ee:transform doc:name="add Name Conference Division" doc:id="35b8ba53-89d6-4b34-80a4-47e8cdad9c4d" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	team_name: vars.Info[0].full_name,	
	team_abbr : payload.team_abbr,
	conference: vars.Info[0].conference,
	division: vars.Info[0].division,
	wins: payload.wins,
	losses : payload.losses,
	"percentage": payload.percentage
}
]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<set-variable value="#[output application/json --- vars.newPayload + payload]" doc:name="newPayload" doc:id="2d1a7c24-18e3-4a7e-8535-ad10e578d8fa" variableName="newPayload" />
			<logger level="INFO" doc:name="Iteration number" doc:id="20fa474b-9c9c-4227-9ba0-a978e3c1625b" message='#["Iteration number " ++ vars.counter]'/>
		</foreach>
		<ee:transform doc:name="to Array with Full Info" doc:id="8a011863-f4cd-4ede-a352-d943ea8bc99e" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars.newPayload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Number of Teams" doc:id="a3a4d2fd-672e-4dba-b56d-dad6ae6f82c0" message='#["Number of Teams " ++ sizeOf(payload)]'/>
	</sub-flow>
	<sub-flow name="findTeamByAbbr" doc:id="c1d101b2-aea7-4c40-bf49-73bee5184dc7" >
		<flow-ref doc:name="allteams" doc:id="d81cce55-a8bd-4c0d-9e36-0ac3bdf1c6b0" name="allteams"/>
		<ee:transform doc:name="Filter by Abbr" doc:id="f87bab3b-f495-4874-a6cc-66e8c95fc088" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.abbreviation == vars.teamAbbr
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Set Variable Info" doc:id="a3702f03-7991-4021-a68a-54273c29f6a5" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="Info" ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="payload" doc:id="228c71f8-13f3-415b-ab81-85b3ad813eed" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="getStandings" doc:id="0b962125-0c57-43b7-82aa-6595543b37c3" >
		<set-variable value="#[message.attributes.queryParams.standingsby]" doc:name="standingsBy" doc:id="13db0879-4f34-4345-bcbf-8201303bc6c6" variableName="standingsBy"/>
		<validation:is-true doc:name="StandingsBy Validation" doc:id="edb7c58b-df43-473a-8df0-ad805bc0782e" expression='#[(["division", "conference"] contains  vars.standingsBy) or (isEmpty(vars.standingsBy))]'>
			<error-mapping targetType="APP:STANDIGSBYVALIDATION" />
		</validation:is-true>
		<choice doc:name="Choice" doc:id="dce53514-0c85-4552-be37-13f7da4c629d" >
			<when expression='#[vars.standingsBy == "conference"]'>
				<flow-ref doc:name="standingsByConference" doc:id="9db9b04b-0b6e-4d68-8265-27f4b40f331d" name="standingsByConference"/>
			</when>
			<when expression='#[vars.standingsBy == "division"]'>
				<flow-ref doc:name="standingsByDivision" doc:id="a3c65147-fdb9-434d-84b4-af6f44d6b894" name="standingsByDivision"/>
			</when>
			<otherwise >
				<flow-ref doc:name="addAdditionalInfo" doc:id="b7a1ee94-8f4e-48ae-821e-02f6fbf1fbe2" name="addAdditionalInfo"/>
				<ee:transform doc:name="remove unnecessary Info" doc:id="d61d4252-a822-4cae-a0cb-c586ca3ad200" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "All_NBA",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="597becb6-c55b-4877-9197-6b2dc8193572" name="addDataToDatabase" />
			</otherwise>
		</choice>
		<logger level="INFO" doc:name="Size of payload" doc:id="0297eac7-c017-46c3-a2b4-960d04ee22c0" message='#["Size of payload " ++ sizeOf(payload)]'/>
	</sub-flow>
	<sub-flow name="standingsByConference" doc:id="2ad3b21f-0e3b-493d-b08c-3f8a80967d8e" >
		<flow-ref doc:name="addAdditionalInfo" doc:id="e5752f8d-f889-439b-9b17-f07a1c41d85c" name="addAdditionalInfo"/>
		<scatter-gather doc:name="Scatter-Gather" doc:id="feb233d8-811e-452a-9f07-c7a9a981cc96" >
			<route >
				<ee:transform doc:name="filter by East" doc:id="f6806945-6727-4537-9919-329581bf0e1f" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.conference == "East"
)]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<ee:transform doc:name="remove unnecessary Info" doc:id="f0fdf307-9586-40f9-be35-40fa3eb534c7" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "East",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name='addDataToDatabase' doc:id="e319eaff-38e6-44ae-ab4e-d0a82a452909" name="addDataToDatabase"/>
			</route>
			<route >
				<ee:transform doc:name="filter by West" doc:id="73f935e4-3a98-4ab5-aff2-ed9dc4e65537" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
payload filter ((object, index) -> object.conference == "West"
)]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<ee:transform doc:name="remove unnecessary  Info" doc:id="296f1bf8-e3d5-4f66-b099-3892999da9f0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "West",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="0035cc16-0fd9-4ad3-a854-e4f6ed24390b" name="addDataToDatabase" />
			</route>
		</scatter-gather>
		<ee:transform doc:name="flatten" doc:id="6291cac5-99d9-4bfe-a9e2-8b97fed45957" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
flatten(payload..*payload)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="SIze of payload" doc:id="16d596c0-4bac-4df6-90d3-4104ea8defcd" message='#["SIze of payload " ++ sizeOf(payload)]'/>
	</sub-flow>
	<sub-flow name="standingsByDivision" doc:id="6c77c919-de77-4923-9bd9-7b70719d83de" >
		<flow-ref doc:name="addAdditionalInfo" doc:id="9c550c08-671d-4d31-a852-d82d75b0a534" name="addAdditionalInfo" />
		<scatter-gather doc:name="Scatter-Gather" doc:id="1daa9566-de70-4480-8346-33084fd14d8f" >
			<route >
				<ee:transform doc:name="filter by Atlantic" doc:id="532c46b1-5284-40ef-9ace-bf8bfca0e838">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.division == "Atlantic"
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<ee:transform doc:name="remove unnecessary Info" doc:id="5acb5d57-d481-45d3-8b8f-cf0e7fb70550" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "Atlantic",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="946d863a-13ae-42c4-9980-0cd1814a415e" name="addDataToDatabase" />
			</route>
			<route >
				<ee:transform doc:name="filter by Central" doc:id="b17c1fd2-e1d6-4216-93c4-91bd9b227bb2">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.division == "Central"
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<ee:transform doc:name="remove unnecessary Info" doc:id="e75a00b4-52d3-44c7-b03d-455b9ecb20f9" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "Central",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="c6279f75-d14a-46a3-9638-871e8b3a6d53" name="addDataToDatabase" />
			</route>
			<route >
				<ee:transform doc:name="filter by SouthEast" doc:id="d9dd962e-344f-479c-b07a-cd7902b52c5d">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.division == "Southeast"
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<ee:transform doc:name="remove unnessary Info" doc:id="d193cca4-b956-4d8e-9c00-737a13edc1b6" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "SouthEast",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="0b56e6a6-e98c-4344-b1d4-b956ce397c75" name="addDataToDatabase" />
			</route>
			<route >
				<ee:transform doc:name="filter by Northwest" doc:id="5cf099a8-e80e-4ae2-9228-4be301ecc012">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.division == "Northwest"
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<ee:transform doc:name="remove unnecessary Info" doc:id="fa45bd73-0259-4cd8-a0b6-8ccf6823fc7f" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "NorthWest",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="738fe5e1-6a93-4efe-830c-5f9e3a94ff92" name="addDataToDatabase" />
			</route>
			<route >
				<ee:transform doc:name="filter by Pacific" doc:id="84f55514-33d0-42ce-8a0b-8123ab9fa0f0">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.division == "Pacific"
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<ee:transform doc:name="remove unnecessary Info" doc:id="81c5c20d-4889-4c6d-9fdd-13a15867be04" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "Pacific",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="3f15fd9d-429d-4d53-af73-8f5754cde248" name="addDataToDatabase" />
			</route>
			<route >
				<ee:transform doc:name="filter by Southwest" doc:id="4c5425bb-0d2c-4159-94e0-aac9d98b0c0e">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.division == "Southwest"
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
				<ee:transform doc:name="remove unnecessary Info" doc:id="9e4ecd00-e3a0-46fe-8a1a-3d32062b8a42" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	standings: "SouthWest",
	teams: payload map ( payload01 , indexOfPayload01 ) -> {
		team_name: payload01.team_name,
		wins: payload01.wins,
		losses: payload01.losses,
		percentage: ((payload01.percentage as String{format: "0.000"}) replace "," with ".") as Number
	}
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<flow-ref doc:name="addDataToDatabase" doc:id="b4bdf3a5-d886-441c-905f-8aea5b924766" name="addDataToDatabase" />
			</route>
		</scatter-gather>
		<ee:transform doc:name="flatten" doc:id="9014b053-3d1e-4985-906c-e64a9769e753" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
flatten(payload..*payload)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="SIze of payload" doc:id="dd6262cd-1927-4806-8380-bca61f128185" message='#["SIze of payload " ++ sizeOf(payload)]' />
	</sub-flow>
	<sub-flow name="validSeason" doc:id="47bb9cb2-3ffc-402c-84b3-49417997da20" >
		<set-variable value="#[vars.season]" doc:name="testSeason" doc:id="33e01e2a-de40-4243-a2d9-415bd9de860d" variableName="testSeason"/>
		<ee:transform doc:name="season as Number" doc:id="2d2e5442-21bd-4d65-bbf5-00636b8d1ae0">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="testSeason"><![CDATA[%dw 2.0
output application/java
---
vars.testSeason  as Number]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
		<validation:is-true doc:name="Season Validation" doc:id="00591dcc-f78e-474d-bb91-3ccb2df6b26e" expression="#[(vars.testSeason &lt; 2022) and (vars.testSeason &gt; 1979)]">
			<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="APP:SEASONVALIDATION" />
		</validation:is-true>
	</sub-flow>
	<sub-flow name="validNameAbbr" doc:id="3dd7f310-ee30-4ca9-be4a-57dea7d9cba3" >
		<set-variable value='#[[&#10;  "Hawks",&#10;  "Celtics",&#10;  "Nets",&#10;  "Hornets",&#10;  "Bulls",&#10;  "Cavaliers",&#10;  "Mavericks",&#10;  "Nuggets",&#10;  "Pistons",&#10;  "Warriors",&#10;  "Rockets",&#10;  "Pacers",&#10;  "Clippers",&#10;  "Lakers",&#10;  "Grizzlies",&#10;  "Heat",&#10;  "Bucks",&#10;  "Timberwolves",&#10;  "Pelicans",&#10;  "Knicks",&#10;  "Thunder",&#10;  "Magic",&#10;  "76ers",&#10;  "Suns",&#10;  "Trail Blazers",&#10;  "Kings",&#10;  "Spurs",&#10;  "Raptors",&#10;  "Jazz",&#10;  "Wizards"&#10;]]' doc:name="names" doc:id="3d40a0fe-3fbd-4e76-aba7-ccec8a416357" variableName="names"/>
		<set-variable value='#[[&#10;  "ATL",&#10;  "BOS",&#10;  "BKN",&#10;  "CHA",&#10;  "CHI",&#10;  "CLE",&#10;  "DAL",&#10;  "DEN",&#10;  "DET",&#10;  "GSW",&#10;  "HOU",&#10;  "IND",&#10;  "LAC",&#10;  "LAL",&#10;  "MEM",&#10;  "MIA",&#10;  "MIL",&#10;  "MIN",&#10;  "NOP",&#10;  "NYK",&#10;  "OKC",&#10;  "ORL",&#10;  "PHI",&#10;  "PHX",&#10;  "POR",&#10;  "SAC",&#10;  "SAS",&#10;  "TOR",&#10;  "UTA",&#10;  "WAS"&#10;]]' doc:name="abbrs" doc:id="1d66df3f-73aa-43ee-a704-89370ad9aecb" variableName="abbrs"/>
		<validation:is-true doc:name="Name Validation" doc:id="305256dc-f743-4f2e-be12-0dba8d2f8364" expression="#[(vars.names contains vars.teamName) or (isEmpty(vars.teamname))]">
			<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="APP:NAMEVALIDATION" />
		</validation:is-true>
		<validation:is-true doc:name="Abbr Validation" doc:id="7b50d379-012f-4438-91d4-da803389b6bf" expression="#[(vars.abbrs contains vars.teamAbr) or (isEmpty(vars.teamAbr))]">
			<error-mapping sourceType="VALIDATION:INVALID_BOOLEAN" targetType="APP:ABBRVALIDATION" />
		</validation:is-true>
		<logger level="INFO" doc:name="Validation Logger" doc:id="6c1677e8-231c-4282-8f68-93452908065b" message="Name and Abreviation is valid"/>
	</sub-flow>
	<sub-flow name="addDataToDatabase" doc:id="3c948ce4-3595-4ea0-998d-a577a999f06f">
		<set-variable doc:name="tableName" doc:id="331b43e6-05bd-4c4d-9aa8-9a76f32cc2f2" variableName="tableName" value='#["results."]' />
		<ee:transform doc:name="set tableName" doc:id="4fc90078-b67a-44df-b394-c80f1679857d">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="tableName"><![CDATA[%dw 2.0
output application/java
---
vars.tableName ++ payload.standings ++ vars.season]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<set-variable value='#["CREATE TABLE IF NOT EXISTS " ++ vars.tableName ++ "(&#10;            id integer,&#10;            team_name varchar(100),&#10;            wins integer,&#10;            losses integer,&#10;            percentage numeric&#10;        )"]' doc:name="creationQuery" doc:id="5d58ef04-a7a1-446e-aad1-8ba435cfc614" variableName="creationQuery" />
		<set-variable value="#[message.payload]" doc:name="oldPayload" doc:id="5d7e1686-05e1-48f5-98da-4df44da69beb" variableName="oldPayload" />
		<db:execute-ddl doc:name="Create Table" doc:id="60fd7ab1-8800-4243-b0d9-c395fc3d31c0" config-ref="Database_Config">
			<db:sql><![CDATA[#[vars.creationQuery]]]></db:sql>
		</db:execute-ddl>
		<set-variable value='#["delete from " ++ vars.tableName]' doc:name="clearingQuery" doc:id="6f1ec15b-ea50-4ae0-b657-49532cf640f6" variableName="clearingQuery" />
		<db:delete doc:name="Delete All Data From Table" doc:id="3f58fdc0-adfb-4a98-9669-a0db7c7967c2" config-ref="Database_Config">
			<db:sql><![CDATA[#[vars.clearingQuery]]]></db:sql>
		</db:delete>
		<ee:transform doc:name="return old payload" doc:id="c1dda644-0fdb-423c-88e9-a99ab0646023">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
vars.oldPayload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each Team" doc:id="81feb510-0941-4677-9a03-92c0a582afb0" collection="#[payload.teams]">
			<set-variable doc:name="insertionQuery" doc:id="9e1025a4-40b8-4698-a1ad-f7d7692fdfa3" variableName="insertionQuery" value='#[""]' />
			<ee:transform doc:name="set insertionQuery" doc:id="4685a509-c82b-4eb6-bda7-c5c3c976b422">
				<ee:message>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="insertionQuery"><![CDATA[%dw 2.0
output application/java
---
vars.insertionQuery ++ "INSERT INTO " ++ vars.tableName ++ "(id, team_name, wins, losses, percentage)
    VALUES (" ++ vars.counter ++ ", '" ++ payload.team_name ++ "', " ++ payload.wins ++ ", " ++ payload.losses ++ ", " ++ payload.percentage ++ ")"]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<db:insert doc:name="Insert into Table" doc:id="2c61cae1-5913-4979-b6d3-87a733a8a163" config-ref="Database_Config">
				<db:sql><![CDATA[#[vars.insertionQuery]]]></db:sql>
			</db:insert>
		</foreach>
		<logger level="INFO" doc:name="Database Logger" doc:id="c040b7fb-1bb9-47a2-9de1-ba2607324689" message='#["Record was added to DataBase successfully"]'/>
	</sub-flow>
	<sub-flow name="findForAllPages" doc:id="7bd804e3-5d09-4596-8c7e-18c07956d793">
		<http:request method="GET" doc:name="GET /allgames" doc:id="beaf0ac5-0e57-48fe-abfe-04ab80962bef" config-ref="HTTP_Request_configuration" path="/games">
			<http:query-params><![CDATA[#[output application/java
---
{
	"postseason" : false,
	"seasons[]" : vars.season,
	"page" : vars.counter,
	"per_page" : 100
}]]]></http:query-params>
		</http:request>
		<logger level="INFO" doc:name="DataBase Loger" doc:id="6d6e0d67-35b5-4255-a0c1-ee66babb75e7" message='#["size of Payload " ++ sizeOf(payload.data)]' />
		<ee:transform doc:name="save result" doc:id="8a96ddd7-0e77-49f7-b2ab-3f3dfa80b5fb">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0 
output application/json 
--- 
payload]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="games"><![CDATA[%dw 2.0
output application/java
---
vars.games ++ payload.data]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="2bec9962-bc9d-4c09-be00-05aa6bfa58ba">
			<when expression="#[!isEmpty(payload.data)]">
				<ee:transform doc:name="increment counter" doc:id="a9cc031b-dfa6-4a95-b1fd-f03270f29e8b">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="counter"><![CDATA[%dw 2.0
output application/java
---
vars.counter + 1]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="findForAllPages" doc:id="243bc3e5-18dc-4790-9ad4-e98e20056848" name="findForAllPages" />
			</when>
			<otherwise>
				<logger level="INFO" doc:name="Numder of Iteration" doc:id="b9124a8c-a6de-4e1b-af2e-660d11646c5d" message='#["Number of iteration " ++ vars.counter-1]' />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="addToDataBaseEast" doc:id="8e3277ff-a629-4be4-abae-953ff7e1a004" >
		<set-variable value="#[payload]" doc:name="oldPayload" doc:id="0ce48158-9474-4097-b1fc-98bfc7c37365" variableName="oldPayload"/>
		<db:execute-ddl doc:name="Create Table East" doc:id="09bf6117-6345-4ef8-a5a1-001977d23f4e" config-ref="Database_Config">
			<db:sql><![CDATA[CREATE TABLE IF NOT EXISTS results.east(
            id integer,
            team_name varchar(100),
            wins integer,
            losses integer,
            percentage numeric
        )]]></db:sql>
		</db:execute-ddl>
		<db:delete doc:name="Delete All Data From Table" doc:id="c91c9444-5b00-4e94-8a26-baebbb7954a4" config-ref="Database_Config">
			<db:sql ><![CDATA[delete from results.east]]></db:sql>
		</db:delete>
		<ee:transform doc:name="return old payload" doc:id="417bd5c0-da95-440d-9890-d94b12f133e2">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
vars.oldPayload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="0dc9cb9e-bc2c-40d2-acb2-2ba9d6b5ebb9" collection="#[payload.teams]">
			<db:insert doc:name="Insert to East" doc:id="0b6a7d65-f729-447b-a442-91ea196e77a6" config-ref="Database_Config">
				<db:sql><![CDATA[INSERT INTO results.east(id, team_name, wins, losses, percentage)
    VALUES (:id, :team_name, :wins, :losses, :percentage)]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	id: vars.counter,
	team_name: payload.team_name,
	wins: payload.wins,
	losses: payload.losses,
	percentage: payload.percentage
	
}]]]></db:input-parameters>
			</db:insert>
		</foreach>
	</sub-flow>
	<sub-flow name="addToDataBaseWest" doc:id="c7432009-931c-4b07-9adb-22f1579cd722">
		<set-variable value="#[message.payload]" doc:name="oldPayload" doc:id="0f0edd59-1bc2-49df-99d2-da343bc7e46f" variableName="oldPayload" />
		<db:execute-ddl doc:name="Create Table West" doc:id="558b6d14-b9cd-4875-962d-3012b66e1092" config-ref="Database_Config">
			<db:sql><![CDATA[CREATE TABLE IF NOT EXISTS results.west(
            id integer,
            team_name varchar(100),
            wins integer,
            losses integer,
            percentage numeric
        )]]></db:sql>
		</db:execute-ddl>
		<db:delete doc:name="Delete All Data From Table" doc:id="ab4a9aeb-0321-4fd3-9ae0-423662ca5b5d" config-ref="Database_Config">
			<db:sql><![CDATA[delete from results.west]]></db:sql>
		</db:delete>
		<ee:transform doc:name="return old payload" doc:id="6c7f0fdc-a8cb-4896-bc8c-4c94cdfa923a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
vars.oldPayload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="d51e3a77-1c40-4aac-8a53-4d745192ec7d" collection="#[payload.teams]">
			<db:insert doc:name="Insert to West" doc:id="e968b5c9-5a3e-4b20-a385-4a6cee655c35" config-ref="Database_Config">
				<db:sql><![CDATA[INSERT INTO results.west(id, team_name, wins, losses, percentage)
    VALUES (:id, :team_name, :wins, :losses, :percentage)]]></db:sql>
				<db:input-parameters><![CDATA[#[{
	id: vars.counter,
	team_name: payload.team_name,
	wins: payload.wins,
	losses: payload.losses,
	percentage: payload.percentage
	
}]]]></db:input-parameters>
			</db:insert>
		</foreach>
	</sub-flow>
</mule>
