<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="allteams" doc:id="aaa1eaff-0b8e-4142-a92e-21cdd7f1394c" >
		<http:request method="GET" doc:name="GET /allteams" doc:id="91409d0f-05f7-4893-862d-17667d2dbed8" config-ref="HTTP_Request_configuration" path="/teams"/>
		<logger level="INFO" doc:name="Logger" doc:id="7f18e868-e01f-4556-badc-5eb7a1ca5764" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="allgames" doc:id="1d2abf3c-16a2-41dd-947e-ae276a0a3ac6" >
		<set-variable value="#[attributes.queryParams.season]" doc:name="season" doc:id="79463f57-85ee-4579-a73c-95064c8c4e5b" variableName="season" />
		<set-variable value="#[[]]" doc:name="games" doc:id="c523a437-c73d-461e-9f3a-ec880e2f0065" variableName="games" />
		<set-variable value="#[0]" doc:name="counter" doc:id="2e184d12-efc6-4c29-94db-18dfb595a60e" variableName="counter" />
		<logger level="INFO" doc:name="Logger Before All Pages" doc:id="531fc58c-1443-4cd6-a166-0202d01d9a0b" message="#[payload]" />
		<flow-ref doc:name="findForAllPages" doc:id="4978c520-35bf-4bfa-9d02-856b67100fd9" name="findForAllPages"/>
		<ee:transform doc:name="All games for season" doc:id="779d098d-2204-4d12-a484-9fde214b3f8d" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
vars.games]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="71269e45-43ae-431a-8076-0c86f8296077" message="#[payload]" />
	</sub-flow>
	<sub-flow name="findForAllPages" doc:id="91a68584-e17e-4e33-afd7-026dd935ea1a" >
		<http:request method="GET" doc:name="GET /allgames" doc:id="8000bcf1-1640-4e3a-b154-54216eb0ff95" config-ref="HTTP_Request_configuration" path="/games">
				<http:query-params><![CDATA[#[output application/java
---
{
	"seasons[]" : vars.season,
	"page" : vars.counter,
	"per_page" : 100
}]]]></http:query-params>
			</http:request>
		<logger level="INFO" doc:name="DataBase Loger" doc:id="ebfa9191-75b6-4499-826f-43fae18eafe7" message="payload"/>
		<ee:transform doc:name="save result" doc:id="6f201922-d183-4472-a28c-654c5cd09d1b">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0 
output application/json 
--- 
payload]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="games"><![CDATA[%dw 2.0
output application/java
---
vars.games ++ payload.data]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<choice doc:name="Choice" doc:id="7b9ac99f-0958-42bc-9084-c93830f5ca69">
			<when expression="#[!isEmpty(payload.data)]">
				<ee:transform doc:name="increment counter" doc:id="579c5a5e-086e-49e2-ac45-1a1ac511677e">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
					<ee:variables>
						<ee:set-variable variableName="counter"><![CDATA[%dw 2.0
output application/java
---
vars.counter + 1]]></ee:set-variable>
					</ee:variables>
				</ee:transform>
				<flow-ref doc:name="findForAllPages" doc:id="46cfc242-5bb3-4eac-b870-681b402b8be0" name="findForAllPages" />
			</when>
			<otherwise>
				<logger level="INFO" doc:name="Logger" doc:id="38fde38a-0fc0-49b6-9148-a98439882b43" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="gamesbyteamabr" doc:id="494a3ad1-b21a-472f-8446-78e5a9581483" >
		<set-variable value="#[attributes.queryParams.abbreviation]" doc:name="teamAbr" doc:id="0800195a-c730-48bb-912e-5993b858dd9d" variableName="teamAbr"/>
		<flow-ref doc:name="allgames" doc:id="99d11d63-0125-4f23-8aa6-d02f99a1f06e" name="allgames" />
		<ee:transform doc:name="byabr" doc:id="90a8bd08-30b2-41c9-ab2a-3edd4a53d777" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.home_team.abbreviation == vars.teamAbr 
	or object.visitor_team.abbreviation == vars.teamAbr
) 
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="transform to normal view with winner" doc:id="6b01c829-1a6b-4684-b701-d89a187fc95a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="violet circle" doc:id="dee3c419-55f5-490e-a122-b9f045874085" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="gamesbyname" doc:id="e4187975-397e-4eb6-a89c-500f4a885ae1" >
		<set-variable value="#[attributes.queryParams.teamname]" doc:name="teamName" doc:id="ee1c136b-83ed-4fe9-a520-b35efa79486a" variableName="teamName" />
		<flow-ref doc:name="allgames" doc:id="99e2fd7a-c6ef-407a-a6bf-86b25032a62f" name="allgames" />
		<ee:transform doc:name="byname" doc:id="2e294d4a-dcfc-47d6-a069-559fc1896ea1" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload filter ((object, index) -> object.home_team.name == vars.teamName 
	or  object.visitor_team.name == vars.teamName
) 
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="transform to normal view with winner" doc:id="8923ed8b-2985-4d86-aef9-820726ee7d2a">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="another violet circle" doc:id="aeeac539-69e8-4733-b533-03f81a794dbc" message="#[payload]" />
	</sub-flow>
	<sub-flow name="findWinnersOfTheGame" doc:id="f25799f0-bb80-4c0a-b932-afe6b294b493" >
		<flow-ref doc:name="allgames" doc:id="ac204f3c-8b3b-4dd2-af63-b6f1ae254451" name="allgames" />
		<ee:transform doc:name="transform to normal view with winner" doc:id="de8411e6-7fff-4c86-a738-04388c13bf11" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload map ( payload01 , indexOfPayload01 ) -> {
	home_team: payload01.home_team.full_name,
	visitor_team: payload01.visitor_team.full_name,
	score: payload01.home_team_score ++ "-" ++ payload01.visitor_team_score,
	winner: if(payload01.home_team_score > payload01.visitor_team_score)
		(payload01.home_team.abbreviation) else (payload01.visitor_team.abbreviation)
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="eb3885b5-8ddc-4336-be44-e4b05cbe8d00" />
	</sub-flow>
</mule>
